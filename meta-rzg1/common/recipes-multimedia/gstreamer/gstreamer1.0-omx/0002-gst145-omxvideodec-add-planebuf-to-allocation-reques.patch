From d0343f11f144cd214cbe2147685ece1b1f07e530 Mon Sep 17 00:00:00 2001
From: Long Dang <long.dang.aj@rvc.renesas.com>
Date: Fri, 9 Sep 2016 09:35:53 +0700
Subject: [PATCH 2/5] gst145-omxvideodec:add planebuf to allocation request

Porting from a patch in Linux 3.10 environment

Signed-off-by: Long Dang <long.dang.aj@rvc.renesas.com>
---
 omx/gstomxbufferpool.c | 14 ++++++++++++--
 omx/gstomxvideodec.c   |  2 ++
 2 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/omx/gstomxbufferpool.c b/omx/gstomxbufferpool.c
index 4a2156f..8802276 100644
--- a/omx/gstomxbufferpool.c
+++ b/omx/gstomxbufferpool.c
@@ -542,7 +542,7 @@ gst_omx_buffer_pool_free_buffer (GstBufferPool * bpool, GstBuffer * buffer)
 #ifdef HAVE_MMNGRBUF
 static GstBuffer *
 gst_omx_buffer_pool_request_videosink_buffer_creation (GstOMXBufferPool * pool,
-    gint dmabuf_fd[GST_VIDEO_MAX_PLANES], gint stride[GST_VIDEO_MAX_PLANES])
+    gint dmabuf_fd[GST_VIDEO_MAX_PLANES], gpointer plane_buf[GST_VIDEO_MAX_PLANES], gint stride[GST_VIDEO_MAX_PLANES])
 {
   GstQuery *query;
   GValue val = { 0, };
@@ -551,6 +551,7 @@ gst_omx_buffer_pool_request_videosink_buffer_creation (GstOMXBufferPool * pool,
   GstBuffer *buffer;
   GArray *dmabuf_array;
   GArray *stride_array;
+  GArray *planebuf_array;
   gint n_planes;
   gint i;

@@ -559,11 +560,13 @@ gst_omx_buffer_pool_request_videosink_buffer_creation (GstOMXBufferPool * pool,

   dmabuf_array = g_array_new (FALSE, FALSE, sizeof (gint));
   stride_array = g_array_new (FALSE, FALSE, sizeof (gint));
+  planebuf_array = g_array_new (FALSE, FALSE, sizeof (gpointer));

   n_planes = GST_VIDEO_INFO_N_PLANES (&pool->video_info);
   for (i = 0; i < n_planes; i++) {
     g_array_append_val (dmabuf_array, dmabuf_fd[i]);
     g_array_append_val (stride_array, stride[i]);
+    g_array_append_val (planebuf_array, plane_buf[i]);
   }

   structure = gst_structure_new ("videosink_buffer_creation_request",
@@ -571,6 +574,7 @@ gst_omx_buffer_pool_request_videosink_buffer_creation (GstOMXBufferPool * pool,
       "height", G_TYPE_INT, pool->port->port_def.format.video.nFrameHeight,
       "stride", G_TYPE_ARRAY, stride_array,
       "dmabuf", G_TYPE_ARRAY, dmabuf_array,
+      "planebuf", G_TYPE_ARRAY, planebuf_array,
       "allocator", G_TYPE_POINTER, &val,
       "format", G_TYPE_STRING,
       gst_video_format_to_string (pool->video_info.finfo->format),
@@ -585,6 +589,7 @@ gst_omx_buffer_pool_request_videosink_buffer_creation (GstOMXBufferPool * pool,
     gst_query_unref (query);
     g_array_free (dmabuf_array, TRUE);  /* free array when function error or failed */
     g_array_free (stride_array, TRUE);  /* free array when function error or failed */
+    g_array_free (planebuf_array, TRUE);  /* free array when function error or failed */
     return NULL;
   }

@@ -596,12 +601,14 @@ gst_omx_buffer_pool_request_videosink_buffer_creation (GstOMXBufferPool * pool,
     gst_query_unref (query);
     g_array_free (dmabuf_array, TRUE);  /* free array when function error or failed */
     g_array_free (stride_array, TRUE);  /* free array when function error or failed */
+    g_array_free (planebuf_array, TRUE);  /* free array when function error or failed */
     return NULL;
   }

   gst_query_unref (query);
   g_array_free (dmabuf_array, TRUE);
   g_array_free (stride_array, TRUE);
+  g_array_free (planebuf_array, TRUE);

   return buffer;
 }
@@ -669,6 +676,7 @@ gst_omx_buffer_pool_acquire_buffer (GstBufferPool * bpool,
         gint i;
         gint dmabuf_fd[GST_VIDEO_MAX_PLANES];
         gint plane_size[GST_VIDEO_MAX_PLANES];
+        gpointer plane_buf[GST_VIDEO_MAX_PLANES];
         guint phys_addr;
         OMXR_MC_VIDEO_DECODERESULTTYPE *decode_res =
                (OMXR_MC_VIDEO_DECODERESULTTYPE *) omx_buf->
@@ -695,6 +703,7 @@ gst_omx_buffer_pool_acquire_buffer (GstBufferPool * bpool,

         plane_size[0] = vmeta->stride[0] *
             GST_VIDEO_INFO_COMP_HEIGHT (&pool->video_info, 0);
+        plane_buf[0] = omx_buf->omx_buf->pBuffer;

         /* Export dmabuf file descriptors from second and subsequent planes */
         n_planes = GST_VIDEO_INFO_N_PLANES (&pool->video_info);
@@ -702,6 +711,7 @@ gst_omx_buffer_pool_acquire_buffer (GstBufferPool * bpool,
           phys_addr = (guint) decode_res->pvPhysImageAddressY + vmeta->offset[i];
           plane_size[i] = vmeta->stride[i] *
               GST_VIDEO_INFO_COMP_HEIGHT (&pool->video_info, i);
+          plane_buf[i] = omx_buf->omx_buf->pBuffer + vmeta->offset[i];

           if (!gst_omx_buffer_pool_export_dmabuf (pool, phys_addr, plane_size[i],
                   page_size, &vdbuf_data->id_export[i], &dmabuf_fd[i])) {
@@ -712,7 +722,7 @@ gst_omx_buffer_pool_acquire_buffer (GstBufferPool * bpool,

         if (pool->vsink_buf_req_supported)
           new_buf = gst_omx_buffer_pool_request_videosink_buffer_creation (pool,
-              dmabuf_fd, vmeta->stride);
+              dmabuf_fd, plane_buf, vmeta->stride);
         else {
           GstVideoMeta *new_meta;

diff --git a/omx/gstomxvideodec.c b/omx/gstomxvideodec.c
index 1d61509..5c51fec 100644
--- a/omx/gstomxvideodec.c
+++ b/omx/gstomxvideodec.c
@@ -1552,6 +1552,8 @@ gst_omx_video_dec_loop (GstOMXVideoDec * self)
         goto caps_failed;
       }

+      /* ...force clearing of reconfiguration flag to prevent subsequent buffers allocation */
+      gst_pad_check_reconfigure(GST_VIDEO_DECODER_SRC_PAD(self));
       gst_video_codec_state_unref (state);

       GST_VIDEO_DECODER_STREAM_UNLOCK (self);
--
1.9.1
