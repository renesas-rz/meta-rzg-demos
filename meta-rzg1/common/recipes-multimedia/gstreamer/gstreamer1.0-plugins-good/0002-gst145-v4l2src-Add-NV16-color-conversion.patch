From cb38bed6dfbf25ad53eadaa95703937c2b9123e8 Mon Sep 17 00:00:00 2001
From: Tram Nguyen <tram.nguyen.xw@rvc.renesas.com>
Date: Thu, 8 Sep 2016 14:13:36 +0700
Subject: [PATCH 2/3] gst145-v4l2src: Add NV16 color conversion

Porting from a patch in Linux 3.10 environment

Signed-off-by: Tram Nguyen <tram.nguyen.xw@rvc.renesas.com>
---
 sys/v4l2/gstv4l2src.c | 24 ++++++++++++++++++++++++
 1 file changed, 24 insertions(+)

diff --git a/sys/v4l2/gstv4l2src.c b/sys/v4l2/gstv4l2src.c
index 80f5665..eee3e69 100644
--- a/sys/v4l2/gstv4l2src.c
+++ b/sys/v4l2/gstv4l2src.c
@@ -81,6 +81,8 @@ enum

 static GstVideoFormat vin_format;         /*Check format in cap*/

+static gint  vin_width;
+static gint  vin_height;
 static guint gst_v4l2_signals[LAST_SIGNAL] = { 0 };

 GST_IMPLEMENT_V4L2_COLOR_BALANCE_METHODS (GstV4l2Src, gst_v4l2src);
@@ -447,6 +449,8 @@ gst_v4l2src_set_caps (GstBaseSrc * src, GstCaps * caps)
   /*Get format of cap to check in gst_v4l2src_decide_allocation function*/
   gst_video_info_from_caps (&info, caps);
   vin_format = GST_VIDEO_INFO_FORMAT (&info);
+  vin_width = GST_VIDEO_INFO_WIDTH (&info);
+  vin_height = GST_VIDEO_INFO_HEIGHT (&info);

   /* make sure the caps changed before doing anything */
   if (gst_v4l2_object_caps_equal (obj, caps))
@@ -778,6 +782,26 @@ gst_v4l2src_create (GstPushSrc * src, GstBuffer ** buf)
   GST_BUFFER_TIMESTAMP (*buf) = timestamp;
   GST_BUFFER_DURATION (*buf) = duration;

+  if(vin_format == GST_VIDEO_FORMAT_NV12)
+  {
+    /*data from VIN is still NV16 and need to be converted to NV12*/
+    GstMapInfo map;
+    guint8 * ptr_tmp;
+    gint i;
+    gsize size_new;
+
+    gst_buffer_map (buf, &map, GST_MAP_WRITE);
+    ptr_tmp = map.data;
+    ptr_tmp += vin_width * vin_height;
+
+    for (i=1; i*2 < vin_height; i++)
+        memcpy((ptr_tmp + i*vin_width), (ptr_tmp + i*vin_width*2), vin_width);
+
+    size_new = map.size *3/4;
+    gst_buffer_unmap (buf, &map);
+    gst_buffer_set_size (buf, size_new);
+  }
+
   return ret;

   /* ERROR */
--
1.9.1
