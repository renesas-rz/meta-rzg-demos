#!/bin/sh

case "$1" in
	start)
		export LD_LIBRARY_PATH="/lib:/usr/lib:/usr/local/lib:"
		amixer set 'PCM' 70% 
		amixer set 'Headphone' 70% 
		amixer set 'Mic' 70%
		modprobe -a mmngr mmngrbuf s3ctl uvcs_cmn vspm fdpm vsp2
		export XDG_RUNTIME_DIR=/run/user/root
		echo 2 > /proc/sys/kernel/printk   # Disable kernel warning, or it will appear rapidly due to network
		export LD_PRELOAD="/usr/lib/libEGL.so"   # This is need to run Qt app on Wayland

		echo "Start Doorphone"
		# Auto run Doorphone demo, only on Basephone
		ipaddr=`ifconfig eth0 | awk '/inet addr/{print substr($2,6)}'`
		if [ $ipaddr = "192.168.10.100" ]
		then
			/home/root/doorphone/simpleplayer &
		fi

		# Run outdoor script if this is Outdoor
		if [ $ipaddr = "192.168.10.101" ]
		then
			/home/root/doorphone/run_outdoor_opencv.sh
		fi
		
		if [ $ipaddr = "192.168.11.100" ]
		then
			ifconfig eth0 192.168.10.100
			/home/root/doorphone/simpleplayer &
		fi
	;;

	stop)
		echo "Stopping Doorphone"
		# Kill Doorphone on Basephone
		ipaddr=`ifconfig eth0 | awk '/inet addr/{print substr($2,6)}'`
		if [ $ipaddr = "192.168.10.100" ]
		then
			killall simpleplayer &> /dev/null
		fi

		# Kill Doorphone on Outdoor
		if [ $ipaddr = "192.168.10.101" ]
		then
			killall run_outdoor_opencv.sh gst-launch-1.0 guess-mess GPIO_button &> /dev/null
		fi
		
		if [ $ipaddr = "192.168.11.100" ]
		then
			killall simpleplayer run_outdoor_opencv_1board.sh gst-launch-1.0 &> /dev/null
			ifconfig eth0 192.168.10.100
		fi
	;;

	restart)
		$0 stop
		sleep 1
		$0 start
	;;

	*)
		echo "usage: $0 { start | stop | restart }"
	;;
esac

exit 0
